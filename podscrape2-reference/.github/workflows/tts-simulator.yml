name: TTS Simulator

on:
  workflow_dispatch:
    inputs:
      topics:
        description: "Topic names (comma or newline separated)"
        required: false
      timestamp:
        description: "Override timestamp (UTC, YYYYMMDD_HHMMSS)"
        required: false
  pull_request:
    paths:
      - .github/workflows/tts-simulator.yml
      - scripts/simulate_tts_output.py

jobs:
  simulate:
    name: Generate Placeholder MP3s
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Generate placeholder MP3 files
        env:
          INPUT_TOPICS: ${{ inputs.topics }}
          INPUT_TIMESTAMP: ${{ inputs.timestamp }}
        run: |
          set -euo pipefail
          TIMESTAMP=${INPUT_TIMESTAMP:-$(date -u +"%Y%m%d_%H%M%S")}
          TOPIC_DATA=${INPUT_TOPICS:-Simulated Digest}
          TOPIC_DATA=$(echo "$TOPIC_DATA" | tr ',' '\n')
          mapfile -t TOPICS <<< "$TOPIC_DATA"
          if [ ${#TOPICS[@]} -eq 0 ]; then
            TOPICS+=("Simulated Digest")
          fi
          echo "Using timestamp: $TIMESTAMP"
          echo "Topics:" && printf '  - %s\n' "${TOPICS[@]}"

          mkdir -p artifacts/simulated-tts
          BASELINE=$(mktemp)
          find data/completed-tts/current -maxdepth 1 -type f -name '*.mp3' -print | sort > "$BASELINE" || true

          python3 scripts/simulate_tts_output.py --timestamp "$TIMESTAMP" --topics "${TOPICS[@]}"

          GENERATED=$(mktemp)
          find data/completed-tts/current -maxdepth 1 -type f -name '*.mp3' -print | sort > "$GENERATED"
          comm -13 "$BASELINE" "$GENERATED" > artifacts/simulated-tts/new_files.txt
          if [ ! -s artifacts/simulated-tts/new_files.txt ]; then
            echo "No new MP3 files detected" >&2
            exit 1
          fi
          while IFS= read -r mp3_path; do
            cp "$mp3_path" artifacts/simulated-tts/
          done < artifacts/simulated-tts/new_files.txt
          ls -l artifacts/simulated-tts

      - name: List generated files
        run: |
          ls -R data/completed-tts || true

      - name: Upload simulated MP3 artifact
        uses: actions/upload-artifact@v4
        with:
          name: simulated-tts-${{ github.run_id }}
          path: artifacts/simulated-tts/
          if-no-files-found: error
