name: Publishing Only

on:
  workflow_dispatch:
    inputs:
      days_back:
        description: "Discovery lookback window (default: 7)"
        required: false
        default: "7"

concurrency:
  group: publishing-only-${{ github.ref }}
  cancel-in-progress: true

jobs:
  publishing:
    name: Test Publishing Pipeline
    runs-on: ubuntu-latest

    permissions:
      contents: write
      packages: write

    env:
      PYTHON_VERSION: "3.13"
      VENV_PATH: .venv
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
      GITHUB_REPOSITORY: ${{ secrets.GH_REPOSITORY }}
      PIPELINE_RUN_ID: ${{ format('{0}-{1}', github.run_id, github.run_attempt) }}
      PIPELINE_WORKFLOW_NAME: ${{ github.workflow }}
      PIPELINE_TRIGGER: ${{ github.event_name }}
      DAYS_BACK: ${{ inputs.days_back }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure git for commits
        run: |
          git config --global user.name "Paul Brown"
          git config --global user.email "brownpr0@gmail.com"

      - name: Ensure required secrets present
        run: |
          missing=()
          for var in DATABASE_URL GITHUB_TOKEN GITHUB_REPOSITORY; do
            if [ -z "${!var}" ]; then
              missing+=("$var")
            fi
          done
          if [ ${#missing[@]} -gt 0 ]; then
            echo "Missing secrets: ${missing[*]}" >&2
            exit 1
          fi

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip downloads
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-${{ env.PYTHON_VERSION }}-
            pip-${{ runner.os }}-

      - name: Cache virtual environment
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-
            venv-${{ runner.os }}-

      - name: Install dependencies
        run: |
          if [ ! -d "${VENV_PATH}" ]; then
            python -m venv "${VENV_PATH}"
          fi
          source "${VENV_PATH}/bin/activate"
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Check GitHub Releases
        run: |
          source "${VENV_PATH}/bin/activate"
          echo "=== Checking recent GitHub releases ==="
          gh release list --repo "$GITHUB_REPOSITORY" --limit 10

      # Publishing Pipeline - Upload MP3s to GitHub and update database
      # ARCHITECTURE NOTE (v1.49): RSS feed is now generated dynamically by Next.js API!
      #   - API route queries database directly: web_ui_hosted/app/api/rss/daily-digest/route.ts
      #   - Public URL: https://podcast.paulrbrown.org/daily-digest.xml (via vercel.json rewrite)
      #   - Benefits: Instant updates (no git commits), always accurate (reads from database)
      #   - This workflow only: uploads MP3s to GitHub, updates database status
      #   - No RSS file generation, no git commits, no Vercel deployment wait needed
      - name: Run Publishing Pipeline
        env:
          TARGET_BRANCH: ${{ github.ref_name }}
        run: |
          source "${VENV_PATH}/bin/activate"

          echo "=== Running Publishing Pipeline ==="
          echo "Target branch: $TARGET_BRANCH"
          echo "Repository: $GITHUB_REPOSITORY"
          echo "Days back: ${DAYS_BACK:-7}"

          python scripts/run_publishing.py --verbose --days-back "${DAYS_BACK:-7}"

          echo ""
          echo "‚úÖ Publishing complete!"
          echo "üì° RSS feed is generated dynamically by Next.js API route"
          echo "üåê Feed URL: https://podcast.paulrbrown.org/daily-digest.xml"
          echo "‚ö° Episodes served directly from database with edge caching"

      - name: Verify RSS Feed API
        run: |
          echo "=== Verifying RSS feed API ==="
          echo "RSS feed is available at: https://podcast.paulrbrown.org/daily-digest.xml"
          echo ""

          # Check if RSS API is responding
          if curl -s https://podcast.paulrbrown.org/daily-digest.xml | head -20 | grep -q "<rss"; then
            echo "‚úÖ RSS feed API responding successfully"
            echo ""
            echo "Recent episodes:"
            curl -s https://podcast.paulrbrown.org/daily-digest.xml | grep "<title>" | head -5
          else
            echo "‚ö†Ô∏è  RSS feed API may need time to propagate"
          fi
